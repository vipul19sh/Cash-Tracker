<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cash Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d1117;
  --panel:#161b22;
  --accent:#3b82f6;
  --text:#e6edf3;
  --danger:#ef4444;
  --success:#22c55e;
  --muted:#8b949e;
}
body{
  font-family:'Outfit',sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:24px;
}
.container{
  background:var(--panel);
  border-radius:12px;
  padding:24px;
  max-width:900px;
  margin:0 auto 24px auto;
  box-shadow:0 0 20px rgba(0,0,0,.25);
  animation:fadeIn .3s ease;
}
h3{margin-top:0;color:var(--accent);}
table{width:100%;border-collapse:collapse;}
th,td{text-align:center;padding:10px;}
th{color:var(--muted);font-weight:500;border-bottom:1px solid #222;}
tr:nth-child(even){background:#0f141a;}
input[type=text]{width:60px;text-align:center;background:#0d1117;color:var(--text);border:none;font-size:16px;}
button{
  border:none;border-radius:8px;padding:14px 18px;font-weight:600;
  color:#fff;cursor:pointer;transition:.2s;letter-spacing:.3px;
}
button:active{transform:scale(.95);}
button.success{background:var(--success);}
button.danger{background:var(--danger);}
button.accent{background:var(--accent);}
button.secondary{background:#30363d;}
.grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:16px;
}
.side{
  background:#0d1117;border-radius:8px;padding:16px;
  box-shadow:inset 0 0 8px rgba(0,0,0,.4);
}
.side h3{font-size:18px;}
.quick-buttons{display:flex;flex-wrap:wrap;gap:12px;}
.quick-buttons button{flex:1 1 30%; font-size:18px; padding:18px;}
.summary{margin-top:20px;background:#0d1117;border-radius:8px;padding:14px;}
.floating-bar{
  position:fixed;bottom:16px;right:16px;
  background:var(--accent);padding:12px 24px;border-radius:40px;
  color:#fff;font-weight:600;font-size:18px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  animation:pulse 2s infinite;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
@keyframes pulse{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}
#logBox{
  max-height:220px;overflow-y:auto;margin-top:12px;
  background:#0d1117;border-radius:8px;padding:10px;font-size:14px;
}
.hidden{
  display:none !important;
  visibility:hidden !important;
  opacity:0 !important;
}

/* NEW: Popup styling */
.popup-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;
  z-index:1000;
}
.popup{
  background:var(--panel);padding:24px;border-radius:12px;max-width:400px;width:90%;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
}
.popup table{width:100%;margin-bottom:16px;}
.popup h3{text-align:center;margin-bottom:16px;}
.popup input[type=number]{width:60px;text-align:center;background:#0d1117;color:var(--text);border:none;font-size:16px;}
.popup .actions{display:flex;justify-content:space-between;}
</style>
</head>
<body>
<script>
// Force popup hidden before anything else loads (prevents stuck open state)
document.addEventListener("DOMContentLoaded", ()=>{
  const p=document.getElementById("manualPopup");
  if(p){
    p.classList.add("hidden");
    p.style.display="none";
    // remove display:none later when opening
    setTimeout(()=>p.style.display="",0);
  }
});
</script>

<div class="container" id="setupContainer">
  <h3>Set Opening Balance</h3>
  <table id="startingCashTable"><thead><tr><th>â‚¹</th><th>Count</th></tr></thead><tbody></tbody></table>
  <button class="success" onclick="startDay()">Start Day</button>
</div>

<div class="container hidden" id="mainContainer">
  <div class="grid">
    <div class="side">
      <h3>Customer Gave</h3>
      <div class="quick-buttons" id="customerBtns"></div>
      <!-- NEW -->
      <button class="accent" style="margin-top:10px;width:100%;" onclick="openManualPopup('received')">Manual Entry</button>
    </div>
    <div class="side">
      <h3>Change Given</h3>
      <div class="quick-buttons" id="changeBtns"></div>
      <!-- NEW -->
      <button class="danger" style="margin-top:10px;width:100%;" onclick="openManualPopup('given')">Manual Entry</button>
    </div>
  </div>

  <div class="summary" id="cashSummary"></div>
  <div class="floating-bar" id="floatingBar">Total: â‚¹0</div>

  <div style="margin-top:16px;">
    <button class="secondary" onclick="toggleLog()">ðŸ§¾ Log</button>
    <button class="accent" onclick="undo()">â†© Undo</button>
    <button class="danger" onclick="endDay()">End Day</button>
  </div>

  <div id="logBox" class="hidden"></div>
</div>

<!-- NEW: Manual Entry Popup -->
<div class="popup-overlay hidden" id="manualPopup">
  <div class="popup">
    <h3 id="popupTitle">Manual Entry</h3>
    <table id="popupTable"><tr><th>â‚¹</th><th>Count</th></tr></table>
    <div class="actions">
      <button class="secondary" onclick="closeManualPopup()">Cancel</button>
      <button class="success" onclick="submitManualPopup()">Add</button>
    </div>
  </div>
</div>
<script>
const denominations=[500,200,100,50,20,10,5,2,1];
let cashData={}; let transactions=[]; let undoStack=[];
let currentManualType=null;
const today=new Date().toISOString().split('T')[0];
const storageKey=`cashData_${today}`;
const txnKey=`transactions_${today}`;
const tbody=document.querySelector("#startingCashTable tbody");

// ====== INITIAL TABLE SETUP ======
denominations.forEach(d=>{
 const row=document.createElement("tr");
 row.innerHTML=`<td>â‚¹${d}</td>
 <td><div style="display:flex;align-items:center;justify-content:center;gap:6px;">
 <button class='secondary' onclick="adjust('${d}',-1)">-</button>
 <input type='text' id='denom_${d}' value='0' oninput="manualEdit('${d}', this.value)">
 <button class='secondary' onclick="adjust('${d}',1)">+</button></div></td>`;
 tbody.appendChild(row);
});

function adjust(denom,diff){
  const el=document.getElementById(`denom_${denom}`);
  let v=parseInt(el.value)||0;
  v=Math.max(0,v+diff);
  el.value=v;
  if(cashData[denom]!==undefined){ cashData[denom]=v; updateSummary(); saveData(); }
}
function manualEdit(denom,val){
  let num=parseInt(val);
  if(isNaN(num)||num<0) num=0;
  cashData[denom]=num;
  updateSummary(); saveData();
}

// ====== RESTORE DAY ======
function restoreDay(){
  const savedCash=JSON.parse(localStorage.getItem(storageKey)||"{}");
  const savedTxns=JSON.parse(localStorage.getItem(txnKey)||"[]");
  if(Object.keys(savedCash).length){
    cashData=savedCash; transactions=savedTxns;
    document.getElementById("setupContainer").classList.add("hidden");
    document.getElementById("mainContainer").classList.remove("hidden");
    buildButtons(); updateSummary(); refreshLog();
    denominations.forEach(d=>{
      const el=document.getElementById(`denom_${d}`);
      if(el) el.value=cashData[d]||0;
    });
  }
  // Always hide popup on load
  document.getElementById("manualPopup").classList.add("hidden");
}

function startDay(){
  denominations.forEach(d=>cashData[d]=parseInt(document.getElementById(`denom_${d}`).value)||0);
  saveData();
  document.getElementById("setupContainer").classList.add("hidden");
  document.getElementById("mainContainer").classList.remove("hidden");
  buildButtons(); updateSummary(); refreshLog();
}

function saveData(){
  localStorage.setItem(storageKey,JSON.stringify(cashData));
  localStorage.setItem(txnKey,JSON.stringify(transactions));
}

// ====== BUILD BUTTONS ======
function buildButtons(){
  const c=document.getElementById("customerBtns"),g=document.getElementById("changeBtns");
  c.innerHTML=""; g.innerHTML="";
  denominations.forEach(d=>{
    const b1=document.createElement("button"); b1.textContent=`â‚¹${d}`; b1.classList.add("accent");
    b1.onclick=()=>recordTxn(d,"received"); c.appendChild(b1);
    const b2=document.createElement("button"); b2.textContent=`â‚¹${d}`; b2.classList.add("danger");
    b2.onclick=()=>recordTxn(d,"given"); g.appendChild(b2);
  });
}

function recordTxn(denom,type){
  undoStack.push(JSON.parse(JSON.stringify(cashData)));
  if(type==="received") cashData[denom]++;
  else if(cashData[denom]>0) cashData[denom]--;
  else return alert("Not enough notes!");
  transactions.push({time:new Date().toLocaleTimeString(),denom,type});
  saveData(); updateSummary(); refreshLog();
}

function undo(){
  if(undoStack.length){
    cashData=undoStack.pop();
    transactions.pop();
    updateSummary(); refreshLog(); saveData();
  }
}

// ====== SUMMARY ======
function updateSummary(){
  let total=0;
  let html="<table><tr><th>â‚¹</th><th>Count</th><th>Amount</th></tr>";
  denominations.forEach(d=>{
    const c=cashData[d]||0;
    const amt=c*d;
    total+=amt;
    html+=`<tr><td>${d}</td><td>${c}</td><td>â‚¹${amt}</td></tr>`;
  });
  html+=`<tr><th colspan='2'>Total</th><th>â‚¹${total}</th></tr></table>`;
  document.getElementById("cashSummary").innerHTML=html;
  document.getElementById("floatingBar").textContent=`Total: â‚¹${total}`;
}

function refreshLog(){
  const lb=document.getElementById("logBox"); lb.innerHTML="";
  transactions.slice().reverse().forEach(txn=>{
    const el=document.createElement("div");
    el.textContent=`[${txn.time}] ${txn.type==="received"?"Received":"Given"} â‚¹${txn.denom}`;
    lb.appendChild(el);
  });
}

function toggleLog(){
  document.getElementById("logBox").classList.toggle("hidden");
}

function endDay(){
  alert("Day Ended!");
  localStorage.removeItem(storageKey);
  localStorage.removeItem(txnKey);
  location.reload();
}

// ====== FIXED: MANUAL ENTRY POPUP ======
function openManualPopup(type){
  currentManualType=type;
  const popup=document.getElementById("manualPopup");
  const table=document.getElementById("popupTable");
  document.getElementById("popupTitle").textContent =
    type==="received"?"Manual Entry - Customer Gave":"Manual Entry - Change Given";
  table.innerHTML="<tr><th>â‚¹</th><th>Count</th></tr>";
  denominations.forEach(d=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td>â‚¹${d}</td><td><input type='number' id='popup_denom_${d}' min='0' value='0'></td>`;
    table.appendChild(row);
  });
  popup.classList.remove("hidden");
}

function closeManualPopup(){
  const popup=document.getElementById("manualPopup");
  popup.classList.add("hidden");
  currentManualType=null;
}

function submitManualPopup(){
  if(!currentManualType) return closeManualPopup();
  undoStack.push(JSON.parse(JSON.stringify(cashData)));
  denominations.forEach(d=>{
    const val=parseInt(document.getElementById(`popup_denom_${d}`).value)||0;
    if(val>0){
      if(currentManualType==="received") cashData[d]+=val;
      else if(cashData[d]>=val) cashData[d]-=val;
      else alert(`Not enough â‚¹${d} notes to give ${val}!`);
      for(let i=0;i<val;i++){
        transactions.push({time:new Date().toLocaleTimeString(),denom:d,type:currentManualType});
      }
    }
  });
  saveData(); updateSummary(); refreshLog();
  closeManualPopup();
}

// ====== EXTRA SAFETY FIXES ======
// Always hide popup on ESC key
document.addEventListener("keydown",e=>{
  if(e.key==="Escape") closeManualPopup();
});
// Allow click on dark background to close
document.getElementById("manualPopup").addEventListener("click",e=>{
  if(e.target.id==="manualPopup") closeManualPopup();
});

// Restore day safely
window.onload = restoreDay;
</script>


</body>

</html>
